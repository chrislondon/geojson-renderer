<!DOCTYPE html>
<html>
  <head>
    <title>geojson-renderer</title>

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css"
    />

    <style>
      #properties-view {
        position: absolute;
        margin: 10px;
        padding: 5px;
        box-sizing: border-box;
        transition: all 0.4s ease-in-out;
        background-color: #e7e2dd;
        opacity: 0.9;
      }

      .hidden {
        display: none;
      }

      .geojson-feature.selected {
        stroke: #ea5b0c;
      }

      .button-blue {
        background-color: #1d71b8;
        border-color: #1d71b8;
      }
    </style>
  </head>
  <body>
    <div id="properties-view" class="hidden">
      <div id="feature-header"></div>
      <table>
        <thead>
          <tr>
            <th>Property</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody id="properties-table"></tbody>
      </table>
      <button class="button button-blue" id="close-button">Close</button>
    </div>

    {%= svg %}

    <script>
      (function () {
        const selectedFeatureContainer = document.getElementById(
          "geojson-selected-feature"
        );
        const propertiesView = document.getElementById("properties-view");
        const features = Array.prototype.slice.call(
          document.getElementsByClassName("geojson-feature")
        );

        document
          .getElementById("close-button")
          .addEventListener("click", () => {
            propertiesView.classList.add("hidden");
          });

        document.addEventListener("click", (event) => {
          const currentlySelectedFeature = features.find((feature) =>
            feature.classList.contains("selected")
          );
          if (currentlySelectedFeature) {
            currentlySelectedFeature.classList.remove("selected");
          }

          const touchedUponFeatures = document
            .elementsFromPoint(event.x, event.y)
            .map((element) => element.parentElement)
            .filter(
              (element) =>
                element &&
                element.classList.contains("geojson-feature") &&
                element.parentElement !== selectedFeatureContainer
            );

          const selectedIndex = touchedUponFeatures.indexOf(
            currentlySelectedFeature
          );

          const newSelectionIndex =
            (selectedIndex + 1) % touchedUponFeatures.length;

          const feature = touchedUponFeatures[newSelectionIndex];

          if (!feature) {
            selectedFeatureContainer.innerHTML = "";
            propertiesView.classList.add("hidden");
            return;
          }

          feature.classList.add("selected");
          selectedFeatureContainer.innerHTML = "";
          selectedFeatureContainer.appendChild(feature.cloneNode(true));

          const properties = JSON.parse(
            feature.getAttribute("data-properties")
          );
          const propertiesContent = document.getElementById("properties-table");
          propertiesContent.innerHTML = Object.entries(properties)
            .map((entry) => `<tr><td>${entry[0]}</td><td>${entry[1]}</td></tr>`)
            .join("\n");
          const featureHeader = document.getElementById("feature-header");

          const title = `<h1>${
            properties.title ? properties.title : properties.name
          }</h1>`;
          featureHeader.innerHTML = title;
          propertiesView.classList.remove("hidden");
        });
      })();
    </script>
  </body>
</html>
